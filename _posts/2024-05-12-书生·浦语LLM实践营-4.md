---
layout:     post
title:      XTunerå¾®è°ƒLLM
subtitle:   ä¹¦ç”ŸÂ·æµ¦è¯­LLMå®è·µè¥-ç¬”è®°4
date:       2024-05-12
author:     Stanlei
catalog: true
tags:
    - LLM
    - Finetune
    - ä¹¦ç”ŸÂ·æµ¦è¯­
---
## 0 è¯¾ç¨‹èƒŒæ™¯

> - [XTuner å¾®è°ƒLLMï¼š1.8Bã€å¤šæ¨¡æ€ã€Agent](https://www.bilibili.com/video/BV15m421j78d/)
> - [InternLM/Tutorial](https://github.com/InternLM/Tutorial)
> - ä¸»è®²äººï¼šXTunerè´¡çŒ®è€…ï¼šæå‰‘é”‹ï¼Œæ±ªå‘¨è°¦ï¼Œç‹ç¾¤

XTuner ä¸€ä¸ªå¤§è¯­è¨€æ¨¡å‹&å¤šæ¨¡æ€æ¨¡å‹å¾®è°ƒå·¥å…·ç®±ã€‚*ç”±* *MMRazor* *å’Œ* *MMDeploy* *è”åˆå¼€å‘ã€‚*

- ğŸ¤“ **å‚»ç“œåŒ–ï¼š** ä»¥ é…ç½®æ–‡ä»¶ çš„å½¢å¼å°è£…äº†å¤§éƒ¨åˆ†å¾®è°ƒåœºæ™¯ï¼Œ**0åŸºç¡€çš„éä¸“ä¸šäººå‘˜ä¹Ÿèƒ½ä¸€é”®å¼€å§‹å¾®è°ƒ**ã€‚
- ğŸƒ **è½»é‡çº§ï¼š** å¯¹äº 7B å‚æ•°é‡çš„LLMï¼Œ**å¾®è°ƒæ‰€éœ€çš„æœ€å°æ˜¾å­˜ä»…ä¸º 8GB** ï¼š **æ¶ˆè´¹çº§æ˜¾å¡âœ…ï¼Œcolabâœ…**

æœ¬èŠ‚è¯¾ä¸»è¦ä»‹ç»äº†å¦‚ä½•åŸºäºXTunerå¾®è°ƒä¸€ä¸ªå…·æœ‰ä¸ªäººè®¤çŸ¥çš„åŠ©æ‰‹ï¼Œä»¥åŠå¦‚ä½•ä½¿ç”¨XTunerå¾®è°ƒå¤šæ¨¡æ€LLMã€‚

## 1 è¯¾ç¨‹ç¬”è®°

**Finetuneï¼šå¢é‡é¢„è®­ç»ƒå’ŒæŒ‡ä»¤è·Ÿéšæ˜¯ç»å¸¸ä¼šç”¨åˆ°ä¸¤ç§çš„å¾®è°ƒæ¨¡å¼**

- å¢é‡é¢„è®­ç»ƒå¾®è°ƒ
  - ä½¿ç”¨åœºæ™¯ï¼šè®©åŸºåº§æ¨¡å‹å­¦ä¹ åˆ°ä¸€äº›æ–°çŸ¥è¯†ï¼Œå¦‚æŸä¸ªå‚ç±»é¢†åŸŸçš„å¸¸è¯†
  - è®­ç»ƒæ•°æ®ï¼šæ–‡ç« ã€ä¹¦ç±ã€ä»£ç ç­‰
- æŒ‡ä»¤è·Ÿéšå¾®è°ƒ
  - ä½¿ç”¨åœºæ™¯ï¼šè®©æ¨¡å‹å­¦ä¼šå¯¹è¯æ¨¡æ¿ï¼Œæ ¹æ®äººç±»æŒ‡ä»¤è¿›è¡Œå¯¹è¯
  - è®­ç»ƒæ•°æ®ï¼šé«˜è´¨é‡çš„å¯¹è¯ã€é—®ç­”æ•°æ®
- ![image-20240512115818311](/img/posts/2024-05-12-ä¹¦ç”ŸÂ·æµ¦è¯­LLMå®è·µè¥-4.assets/image-20240512115818311.png)

> **LoRA**
>
> - æ ¸å¿ƒæ€æƒ³ï¼šé€šè¿‡ä½ç§©åˆ†è§£æ¥æ¨¡æ‹Ÿå‚æ•°çš„æ”¹å˜é‡
> - <img src="/img/posts/2024-05-12-ä¹¦ç”ŸÂ·æµ¦è¯­LLMå®è·µè¥-4.assets/lora_main_method.jpg" alt="img" style="zoom:50%;" />
> - æŠ€æœ¯åŸç†ï¼š
>   - åœ¨æ¶‰åŠåˆ°çŸ©é˜µç›¸ä¹˜çš„æ¨¡å—ï¼Œåœ¨åŸå§‹çš„PLMæ—è¾¹å¢åŠ ä¸€ä¸ªæ–°çš„é€šè·¯ï¼Œé€šè¿‡å‰åä¸¤ä¸ªçŸ©é˜µA,Bç›¸ä¹˜ï¼Œç¬¬ä¸€ä¸ªçŸ©é˜µAè´Ÿè´£é™ç»´ï¼Œç¬¬äºŒä¸ªçŸ©é˜µBè´Ÿè´£å‡ç»´ï¼Œä¸­é—´å±‚ç»´åº¦ä¸ºrï¼Œä»è€Œæ¥æ¨¡æ‹Ÿæ‰€è°“çš„æœ¬å¾ç§©ï¼ˆintrinsic rankï¼‰
>   - r<<dï¼Œræ˜¯çŸ©é˜µçš„ç§©ï¼Œè¿™æ ·çŸ©é˜µè®¡ç®—å°±ä»d x då˜ä¸ºd x r + r x d
>   - åœ¨ä¸‹æ¸¸ä»»åŠ¡è®­ç»ƒæ—¶ï¼Œå›ºå®šæ¨¡å‹çš„å…¶ä»–å‚æ•°ï¼Œåªä¼˜åŒ–æ–°å¢çš„ä¸¤ä¸ªçŸ©é˜µçš„æƒé‡å‚æ•°ï¼Œå°†PLMè·Ÿæ–°å¢çš„é€šè·¯ä¸¤éƒ¨åˆ†çš„ç»“æœåŠ èµ·æ¥ä½œä¸ºæœ€ç»ˆçš„ç»“æœ
>   - Transformerçš„æƒé‡çŸ©é˜µåŒ…æ‹¬Attentionæ¨¡å—é‡Œç”¨äºè®¡ç®—query, key, valueçš„Wqï¼ŒWkï¼ŒWvä»¥åŠå¤šå¤´attentionçš„Wo,ä»¥åŠMLPå±‚çš„æƒé‡çŸ©é˜µï¼ŒLoRAåªåº”ç”¨äºAttentionæ¨¡å—ä¸­çš„4ç§æƒé‡çŸ©é˜µï¼Œè€Œä¸”é€šè¿‡æ¶ˆèå®éªŒå‘ç°åŒæ—¶è°ƒæ•´ Wq å’Œ Wv ä¼šäº§ç”Ÿæœ€ä½³ç»“æœ
> - ç›¸è¾ƒå…¶ä»–æ–¹æ³•**æ¶ˆé™¤äº†æ¨ç†å»¶è¿Ÿ**ï¼ˆå› ä¸ºæ˜¯å°†BAåŠ åˆ°Wä¸Šï¼‰
> - å¯ä»¥é€šè¿‡å¯æ’æ‹”çš„å½¢å¼åˆ‡æ¢åˆ°ä¸åŒçš„ä»»åŠ¡
> - <img src="//img/posts/LLM-PEFT/lora_example.png" alt="img" style="zoom:50%;" />
>
> **QLoRA**
>
> - èƒŒæ™¯ï¼šä¸»è¦æ˜¯**é‡åŒ–**å¾®è°ƒçš„è§’åº¦å‡å°‘äº†æ˜¾å­˜å ç”¨
>   - å¾®è°ƒå¤§æ¨¡å‹éå¸¸æ˜‚è´µï¼Œä»¥LLaMAå‚æ•°æ¨¡å‹ä¸ºä¾‹ï¼Œ16 bitå¾®è°ƒéœ€è¦è¶…è¿‡780GBçš„GPUå†…å­˜
> - **æŠ€æœ¯åŸç†**
>   - åŒ…å«ä¸€ç§ä½ç²¾åº¦å­˜å‚¨æ•°æ®ç±»å‹ï¼ˆé€šå¸¸ä¸º4-bitï¼‰å’Œä¸€ç§è®¡ç®—æ•°æ®ç±»å‹ï¼ˆé€šå¸¸ä¸ºBFloat16ï¼‰
>   - å°†é¢„è®­ç»ƒæ¨¡å‹é‡åŒ–ä¸º 4 bitï¼Œç„¶åæ·»åŠ ä¸€å°ç»„å¯å­¦ä¹ çš„ä½ç§©é€‚é…å™¨æƒé‡è¿›è¡Œå¾®è°ƒ
>     - æå‡ºäº†ä¸¤ç§æŠ€æœ¯å®ç°é«˜ä¿çœŸ4bitå¾®è°ƒ
>       - **4bit NormalFloat**ï¼ˆNF4ï¼‰
>       - **åŒé‡åŒ–**ï¼šå¯¹ç¬¬ä¸€æ¬¡é‡åŒ–åçš„é‚£äº›å¸¸é‡å†è¿›è¡Œä¸€æ¬¡é‡åŒ–ï¼Œå‡å°‘å­˜å‚¨ç©ºé—´
>     - **åˆ†é¡µä¼˜åŒ–å™¨**ï¼šä½¿ç”¨NVIDIAç»Ÿä¸€å†…å­˜ç‰¹æ€§ï¼Œè¯¥ç‰¹æ€§å¯ä»¥åœ¨GPUå¶å°”OOMçš„æƒ…å†µä¸‹ï¼Œè¿›è¡ŒCPUå’ŒGPUä¹‹é—´è‡ªåŠ¨åˆ†é¡µåˆ°åˆ†é¡µçš„ä¼ è¾“ï¼Œä»¥å®ç°æ— é”™è¯¯çš„ GPU å¤„ç†
>   - åœ¨å®è·µä¸­ï¼ŒQLoRAæƒé‡å¼ é‡ä½¿ç”¨æ—¶ï¼Œéœ€è¦å°†ä½æ¯”ç‰¹å¼ é‡å»é‡åŒ–ä¸ºBFloat16ï¼Œç„¶ååœ¨16ä½è®¡ç®—ç²¾åº¦ä¸‹è¿›è¡ŒçŸ©é˜µä¹˜æ³•è¿ç®—

**XTuner**

- ç®€ä»‹
  - ![image-20240512120644585](/img/posts/2024-05-12-ä¹¦ç”ŸÂ·æµ¦è¯­LLMå®è·µè¥-4.assets/image-20240512120644585.png)
- å¯¹æ¯”LLaMA-Factory
  - ![325901204-9c9dfdf4-1efb-4daf-84bf-7c379ae40b8b](/img/posts/2024-05-12-ä¹¦ç”ŸÂ·æµ¦è¯­LLMå®è·µè¥-4.assets/325901204-9c9dfdf4-1efb-4daf-84bf-7c379ae40b8b.png)
  - ![325901627-5ba973b8-8885-4b72-b51b-c69fa1583bdd](/img/posts/2024-05-12-ä¹¦ç”ŸÂ·æµ¦è¯­LLMå®è·µè¥-4.assets/325901627-5ba973b8-8885-4b72-b51b-c69fa1583bdd.png)
- å¿«é€Ÿä¸Šæ‰‹
  - ![image-20240512121145653](/img/posts/2024-05-12-ä¹¦ç”ŸÂ·æµ¦è¯­LLMå®è·µè¥-4.assets/image-20240512121145653.png)
  - ![image-20240512121208736](/img/posts/2024-05-12-ä¹¦ç”ŸÂ·æµ¦è¯­LLMå®è·µè¥-4.assets/image-20240512121208736.png)
  - ![image-20240512121225806](/img/posts/2024-05-12-ä¹¦ç”ŸÂ·æµ¦è¯­LLMå®è·µè¥-4.assets/image-20240512121225806.png)

**å¤šæ¨¡æ€LLMå¾®è°ƒ**

- ![image-20240512121350056](/img/posts/2024-05-12-ä¹¦ç”ŸÂ·æµ¦è¯­LLMå®è·µè¥-4.assets/image-20240512121350056.png)
- ![image-20240512121409635](/img/posts/2024-05-12-ä¹¦ç”ŸÂ·æµ¦è¯­LLMå®è·µè¥-4.assets/image-20240512121409635.png)
- LLaVAæ–¹æ¡ˆ
  - ![image-20240512121445436](/img/posts/2024-05-12-ä¹¦ç”ŸÂ·æµ¦è¯­LLMå®è·µè¥-4.assets/image-20240512121445436.png)
- ä¸»è¦åˆ†ä¸ºé¢„è®­ç»ƒå’Œå¾®è°ƒé˜¶æ®µ
  - ![image-20240512121542673](/img/posts/2024-05-12-ä¹¦ç”ŸÂ·æµ¦è¯­LLMå®è·µè¥-4.assets/image-20240512121542673.png)
  - Pretrainé˜¶æ®µ
    - åœ¨Pretrainé˜¶æ®µä¼šä½¿ç”¨å¤§é‡çš„`å›¾ç‰‡+ç®€å•æ–‡æœ¬ï¼ˆcaption, å³å›¾ç‰‡æ ‡é¢˜ï¼‰`æ•°æ®å¯¹ï¼Œä½¿LLMç†è§£å›¾åƒä¸­çš„**æ™®éç‰¹å¾**ã€‚å³ï¼Œå¯¹å¤§é‡çš„å›¾ç‰‡è¿›è¡Œ**ç²—çœ‹**ã€‚
    - Pretrainé˜¶æ®µè®­ç»ƒå®Œæˆåï¼Œæ¨¡å‹å·²ç»æœ‰è§†è§‰èƒ½åŠ›äº†ï¼Œä½†æ˜¯ç”±äºè®­ç»ƒæ•°æ®ä¸­éƒ½æ˜¯å›¾ç‰‡+å›¾ç‰‡æ ‡é¢˜ï¼Œæ‰€ä»¥æ­¤æ—¶çš„æ¨¡å‹è™½ç„¶æœ‰è§†è§‰èƒ½åŠ›ï¼Œä½†æ— è®ºç”¨æˆ·é—®å®ƒä»€ä¹ˆï¼Œå®ƒéƒ½åªä¼šå›ç­”è¾“å…¥å›¾ç‰‡çš„æ ‡é¢˜ã€‚å³ï¼Œ**æ­¤æ—¶çš„æ¨¡å‹åªä¼šç»™è¾“å…¥å›¾åƒâ€œå†™æ ‡é¢˜â€**ã€‚
  - Finetuneé˜¶æ®µ
    - ä½¿ç”¨`å›¾ç‰‡+å¤æ‚æ–‡æœ¬`æ•°æ®å¯¹ï¼Œæ¥å¯¹Pretrainå¾—åˆ°çš„Image Projectorå³iter_2181.pthè¿›è¡Œè¿›ä¸€æ­¥çš„è®­ç»ƒã€‚
    - è®­ç»ƒæ•°æ®æ„å»º
- åœ¨è¿›è¡Œä¸Šè¿°æ­¥éª¤ä¹‹åï¼ŒLLMå³å¯è¿›åŒ–ä¸ºMLLM
  - æ•°æ®
    - ![322289947-7bab37ec-18f9-4731-979d-c5fc8acf80fa](/img/posts/2024-05-12-ä¹¦ç”ŸÂ·æµ¦è¯­LLMå®è·µè¥-4.assets/322289947-7bab37ec-18f9-4731-979d-c5fc8acf80fa.png)
  - å‰
    - ![ft_before](/img/posts/2024-05-12-ä¹¦ç”ŸÂ·æµ¦è¯­LLMå®è·µè¥-4.assets/ft_before.png)
  - å
    - ![ft_after](/img/posts/2024-05-12-ä¹¦ç”ŸÂ·æµ¦è¯­LLMå®è·µè¥-4.assets/ft_after.png)

## 2 åŸºç¡€ä½œä¸š

### 2.1 ä¸ªäººè®¤çŸ¥å¾®è°ƒ

![314369658-0c4817e8-ddaf-4276-ad16-b65d5ec6b4ae](/img/posts/2024-05-12-ä¹¦ç”ŸÂ·æµ¦è¯­LLMå®è·µè¥-4.assets/314369658-0c4817e8-ddaf-4276-ad16-b65d5ec6b4ae.png)

é¦–å…ˆæ˜¯è®­ç»ƒæ•°æ®çš„æ„å»º

- æ•°æ®ç”Ÿæˆä»£ç ï¼š
  - ![image-20240512124702468](/img/posts/2024-05-12-ä¹¦ç”ŸÂ·æµ¦è¯­LLMå®è·µè¥-4.assets/image-20240512124702468.png)
- å¾®è°ƒæ•°æ®
  - ![image-20240512124735612](/img/posts/2024-05-12-ä¹¦ç”ŸÂ·æµ¦è¯­LLMå®è·µè¥-4.assets/image-20240512124735612.png)

ä¹‹åå¤åˆ¶æœ¬æ¬¡ç”¨åˆ°çš„å¤§æ¨¡å‹ï¼ˆè¿™é‡Œé‡‡ç”¨å»ºç«‹è½¯è¿æ¥çš„æ–¹æ³•ï¼‰

```shell
ln -s /root/share/new_models/Shanghai_AI_Laboratory/internlm2-chat-1_8b model/internlm2-chat-1_8b
```

> é…ç½®æ–‡ä»¶åçš„è§£é‡Š
>
> ä»¥ **internlm2_1_8b_qlora_alpaca_e3** ä¸¾ä¾‹ï¼š
>
> | æ¨¡å‹å         | è¯´æ˜          |
> | -------------- | ------------- |
> | internlm2_1_8b | æ¨¡å‹åç§°      |
> | qlora          | ä½¿ç”¨çš„ç®—æ³•    |
> | alpaca         | æ•°æ®é›†åç§°    |
> | e3             | æŠŠæ•°æ®é›†è·‘3æ¬¡ |

æœ€åå¾—åˆ°çš„æ–‡ä»¶æ ‘ï¼š

![image-20240512125234452](/img/posts/2024-05-12-ä¹¦ç”ŸÂ·æµ¦è¯­LLMå®è·µè¥-4.assets/image-20240512125234452.png)

> **å¸¸ç”¨è¶…å‚**
>
> | å‚æ•°å                     | è§£é‡Š                                                         |
> | -------------------------- | ------------------------------------------------------------ |
> | **data_path**              | æ•°æ®è·¯å¾„æˆ– HuggingFace ä»“åº“å                                |
> | **max_length**             | å•æ¡æ•°æ®æœ€å¤§ Token æ•°ï¼Œè¶…è¿‡åˆ™æˆªæ–­                            |
> | **pack_to_max_length**     | æ˜¯å¦å°†å¤šæ¡çŸ­æ•°æ®æ‹¼æ¥åˆ° max_lengthï¼Œæé«˜ GPU åˆ©ç”¨ç‡           |
> | **accumulative_counts**    | æ¢¯åº¦ç´¯ç§¯ï¼Œæ¯å¤šå°‘æ¬¡ backward æ›´æ–°ä¸€æ¬¡å‚æ•°                     |
> | **sequence_parallel_size** | å¹¶è¡Œåºåˆ—å¤„ç†çš„å¤§å°ï¼Œç”¨äºæ¨¡å‹è®­ç»ƒæ—¶çš„åºåˆ—å¹¶è¡Œ                 |
> | **batch_size**             | æ¯ä¸ªè®¾å¤‡ä¸Šçš„æ‰¹é‡å¤§å°                                         |
> | **dataloader_num_workers** | æ•°æ®åŠ è½½å™¨ä¸­å·¥ä½œè¿›ç¨‹çš„æ•°é‡                                   |
> | **max_epochs**             | è®­ç»ƒçš„æœ€å¤§è½®æ•°                                               |
> | **optim_type**             | ä¼˜åŒ–å™¨ç±»å‹ï¼Œä¾‹å¦‚ AdamW                                       |
> | **lr**                     | å­¦ä¹ ç‡                                                       |
> | **betas**                  | ä¼˜åŒ–å™¨ä¸­çš„ beta å‚æ•°ï¼Œæ§åˆ¶åŠ¨é‡å’Œå¹³æ–¹æ¢¯åº¦çš„ç§»åŠ¨å¹³å‡           |
> | **weight_decay**           | æƒé‡è¡°å‡ç³»æ•°ï¼Œç”¨äºæ­£åˆ™åŒ–å’Œé¿å…è¿‡æ‹Ÿåˆ                         |
> | **max_norm**               | æ¢¯åº¦è£å‰ªçš„æœ€å¤§èŒƒæ•°ï¼Œç”¨äºé˜²æ­¢æ¢¯åº¦çˆ†ç‚¸                         |
> | **warmup_ratio**           | é¢„çƒ­çš„æ¯”ä¾‹ï¼Œå­¦ä¹ ç‡åœ¨è¿™ä¸ªæ¯”ä¾‹çš„è®­ç»ƒè¿‡ç¨‹ä¸­çº¿æ€§å¢åŠ åˆ°åˆå§‹å­¦ä¹ ç‡ |
> | **save_steps**             | ä¿å­˜æ¨¡å‹çš„æ­¥æ•°é—´éš”                                           |
> | **save_total_limit**       | ä¿å­˜çš„æ¨¡å‹æ€»æ•°é™åˆ¶ï¼Œè¶…è¿‡é™åˆ¶æ—¶åˆ é™¤æ—§çš„æ¨¡å‹æ–‡ä»¶               |
> | **prompt_template**        | æ¨¡æ¿æç¤ºï¼Œç”¨äºå®šä¹‰ç”Ÿæˆæ–‡æœ¬çš„æ ¼å¼æˆ–ç»“æ„                       |
> | ......                     | ......                                                       |

```shell
# æŒ‡å®šä¿å­˜è·¯å¾„
xtuner train /root/workspace/xtuner0117/config/internlm2_1_8b_qlora_alpaca_e3_copy.py --work-dir /root/workspace/xtuner0117/train
# ä½¿ç”¨ deepspeed æ¥åŠ é€Ÿè®­ç»ƒ
xtuner train /root/workspace/xtuner0117/config/internlm2_1_8b_qlora_alpaca_e3_copy.py --work-dir /root/workspace/xtuner0117/ft_ds2 --deepspeed deepspeed_zero2
```

è¿‡ç¨‹å¦‚ä¸‹ï¼š

- è®­ç»ƒæ•°æ®æ˜ å°„

  - ![image-20240512131047212](/img/posts/2024-05-12-ä¹¦ç”ŸÂ·æµ¦è¯­LLMå®è·µè¥-4.assets/image-20240512131047212.png)

- å¾®è°ƒç»“æœ

  - 1kæ¡è®­ç»ƒæ•°æ®ï¼šå¯ä»¥çœ‹åˆ°å­˜åœ¨æ¬ æ‹Ÿåˆç°è±¡ï¼Œéƒ¨åˆ†é—®é¢˜æ²¡æ³•å›å¤
    - ![image-20240512150537929](/img/posts/2024-05-12-ä¹¦ç”ŸÂ·æµ¦è¯­LLMå®è·µè¥-4.assets/image-20240512150537929.png)
  - 1wæ¡è®­ç»ƒæ•°æ®ï¼šå¯ä»¥è¾¾åˆ°æ»¡æ„çš„å›ç­”ï¼Œä½†æ˜¯å­˜åœ¨è¿‡æ‹Ÿåˆç°è±¡
    - ![image-20240512150601286](/img/posts/2024-05-12-ä¹¦ç”ŸÂ·æµ¦è¯­LLMå®è·µè¥-4.assets/image-20240512150601286.png)

- å‚æ•°æ ¼å¼è½¬æ¢

  - ```shell
    xtuner convert pth_to_hf /root/workspace/xtuner0117/train/internlm2_1_8b_qlora_alpaca_e3_copy.py /root/workspace/xtuner0117/train/iter_896.pth /root/workspace/xtuner0117/huggingface
    ```

- å‚æ•°åˆå¹¶

  - ```shell
    # è§£å†³ä¸€ä¸‹çº¿ç¨‹å†²çªçš„ Bug 
    export MKL_SERVICE_FORCE_INTEL=1
    
    # è¿›è¡Œæ¨¡å‹æ•´åˆ
    # xtuner convert merge  ${NAME_OR_PATH_TO_LLM} ${NAME_OR_PATH_TO_ADAPTER} ${SAVE_PATH} 
    xtuner convert merge /root/workspace/xtuner0117/model/internlm2-chat-1_8b /root/workspace/xtuner0117/huggingface /root/workspace/xtuner0117/final_model
    ```

- web_demoï¼šå¯ä»¥çœ‹åˆ°è¿‡æ‹Ÿåˆç°è±¡ååˆ†ä¸¥é‡ï¼Œè¿™æ—¢æœ‰è®­ç»ƒæ•°æ®å•ä¸€çš„åŸå› ï¼Œåˆæœ‰æ¨¡å‹å‚æ•°å¤§å°ï¼ˆ1.8Bï¼‰çš„åŸå› 

  - ![image-20240512153213735](/img/posts/2024-05-12-ä¹¦ç”ŸÂ·æµ¦è¯­LLMå®è·µè¥-4.assets/image-20240512153213735.png)

  - ```shell
    streamlit run /root/workspace/xtuner0117/InternLM/chat/web_demo.py --server.address 127.0.0.1 --server.port 6006
    ```

  - ![image-20240512153617942](/img/posts/2024-05-12-ä¹¦ç”ŸÂ·æµ¦è¯­LLMå®è·µè¥-4.assets/image-20240512153617942.png)





### 2.2 å¤ç°å¤šæ¨¡æ€å¾®è°ƒå¤§æ¨¡å‹

é…ç½®æ–‡ä»¶ï¼š

![image-20240512123258946](/img/posts/2024-05-12-ä¹¦ç”ŸÂ·æµ¦è¯­LLMå®è·µè¥-4.assets/image-20240512123258946.png)

![image-20240512123657448](/img/posts/2024-05-12-ä¹¦ç”ŸÂ·æµ¦è¯­LLMå®è·µè¥-4.assets/image-20240512123657448.png)

å¼€å§‹å¾®è°ƒ

```shell
cd /root/workspace/xtuner0117/tutorial/xtuner/llava/
xtuner train /root/workspace/xtuner0117/tutorial/xtuner/llava/llava_internlm2_chat_1_8b_qlora_clip_vit_large_p14_336_lora_e1_gpu8_finetune_copy.py --deepspeed deepspeed_zero2
```

- æ„å»ºæ•°æ®æ˜ å°„
  - ![image-20240512124054000](/img/posts/2024-05-12-ä¹¦ç”ŸÂ·æµ¦è¯­LLMå®è·µè¥-4.assets/image-20240512124054000.png)
- åŠ è½½æ¨¡å‹å‚æ•°
  - ![image-20240512124129080](/img/posts/2024-05-12-ä¹¦ç”ŸÂ·æµ¦è¯­LLMå®è·µè¥-4.assets/image-20240512124129080.png)
- è®­ç»ƒè¿‡ç¨‹
  - ![image-20240512124357178](/img/posts/2024-05-12-ä¹¦ç”ŸÂ·æµ¦è¯­LLMå®è·µè¥-4.assets/image-20240512124357178.png)
- å¾®è°ƒç»“æœï¼šç±»ä¼¼äºæ•™ç¨‹ç»“æœï¼Œèƒ½å¤Ÿç†è§£å¹¶è¯¦ç»†å›ç­”å›¾ç‰‡å†…å®¹
  - ![image-20240512130721598](/img/posts/2024-05-12-ä¹¦ç”ŸÂ·æµ¦è¯­LLMå®è·µè¥-4.assets/image-20240512130721598.png)
